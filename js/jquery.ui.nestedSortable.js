(function(a){a.widget("ui.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,revertOnError:1},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));return a.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){this.element.removeData("nestedSortable").unbind(".nestedSortable");return a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(b){this.position=this._generatePosition(b);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var c=this.options,d=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<c.scrollSensitivity)this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+c.scrollSpeed;else if(b.pageY-this.overflowOffset.top<c.scrollSensitivity)this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-c.scrollSpeed;if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<c.scrollSensitivity)this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+c.scrollSpeed;else if(b.pageX-this.overflowOffset.left<c.scrollSensitivity)this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-c.scrollSpeed}else{if(b.pageY-a(document).scrollTop()<c.scrollSensitivity)d=a(document).scrollTop(a(document).scrollTop()-c.scrollSpeed);else if(a(window).height()-(b.pageY-a(document).scrollTop())<c.scrollSensitivity)d=a(document).scrollTop(a(document).scrollTop()+c.scrollSpeed);if(b.pageX-a(document).scrollLeft()<c.scrollSensitivity)d=a(document).scrollLeft(a(document).scrollLeft()-c.scrollSpeed);else if(a(window).width()-(b.pageX-a(document).scrollLeft())<c.scrollSensitivity)d=a(document).scrollLeft(a(document).scrollLeft()+c.scrollSpeed)}if(d!==false&&a.ui.ddmanager&&!c.dropBehaviour)a.ui.ddmanager.prepareOffsets(this,b)}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var e=this.items.length-1;e>=0;e--){var f=this.items[e],g=f.item[0],h=this._intersectsWithPointer(f);if(!h)continue;if(g!=this.currentItem[0]&&this.placeholder[h==1?"next":"prev"]()[0]!=g&&!a.contains(this.placeholder[0],g)&&(this.options.type=="semi-dynamic"?!a.contains(this.element[0],g):true)){a(g).mouseenter();this.direction=h==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(f)){a(g).mouseleave();this._rearrange(b,f)}else{break}this._clearEmpty(g);this._trigger("change",b,this._uiHash());break}}var i=this.placeholder[0].parentNode.parentNode&&a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?a(this.placeholder[0].parentNode.parentNode):null,j=this._getLevel(this.placeholder),k=this._getChildLevels(this.helper),l=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(l!=null){while(l[0].nodeName.toLowerCase()!="li"||l[0]==this.currentItem[0]){if(l[0].previousSibling){l=a(l[0].previousSibling)}else{l=null;break}}}newList=document.createElement(c.listType);this.beyondMaxLevels=0;if(i!=null&&this.positionAbs.left<i.offset().left){i.after(this.placeholder[0]);this._clearEmpty(i[0]);this._trigger("change",b,this._uiHash())}else if(l!=null&&this.positionAbs.left>l.offset().left+c.tabSize){this._isAllowed(l,j+k+1);if(!l.children(c.listType).length){l[0].appendChild(newList)}l.children(c.listType)[0].appendChild(this.placeholder[0]);this._trigger("change",b,this._uiHash())}else{this._isAllowed(i,j+k)}this._contactContainers(b);if(a.ui.ddmanager)a.ui.ddmanager.drag(this,b);this._trigger("sort",b,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(b,c){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.options.revertOnError){if(this.domPosition.prev){a(this.domPosition.prev).after(this.placeholder)}else{a(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",b,this._uiHash())}else{var d=this.placeholder.parent().closest(this.options.items);for(var e=this.beyondMaxLevels-1;e>0;e--){d=d.parent().closest(this.options.items)}d.after(this.placeholder);this._trigger("change",b,this._uiHash())}}for(var e=this.items.length-1;e>=0;e--){var f=this.items[e].item[0];this._clearEmpty(f)}a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];b=b||{};a(c).each(function(){var c=(a(b.item||this).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/),e=(a(b.item||this).parent(b.listType).parent("li").attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/);if(c){d.push((b.key||c[1]+"["+(b.key&&b.expression?c[1]:c[2])+"]")+"="+(e?b.key&&b.expression?e[1]:e[2]:"root"))}});if(!d.length&&b.key){d.push(b.key+"=")}return d.join("&")},toHierarchy:function(b){function e(c){var d=(a(c).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/);if(d){var f={id:d[2]};if(a(c).children(b.listType).children("li").length>0){f.children=[];a(c).children(b.listType).children("li").each(function(){var b=e(a(this));f.children.push(b)})}return f}}b=b||{};var c=b.startDepthCount||0,d=[];a(this.element).children("li").each(function(){var b=e(a(this));d.push(b)});return d},toArray:function(b){function f(e,g,h){var i=h+1,j,k;if(a(e).children(b.listType).children("li").length>0){g++;a(e).children(b.listType).children("li").each(function(){i=f(a(this),g,i)});g--}j=a(e).attr(b.attribute||"id").match(b.expression||/(.+)[-=_](.+)/);if(g===c+1){k="root"}else{var l=a(e).parent(b.listType).parent("li").attr(b.attribute||"id").match(b.expression||/(.+)[-=_](.+)/);k=l[2]}if(j){d.push({item_id:j[2],parent_id:k,depth:g,left:h,right:i})}h=i+1;return h}b=b||{};var c=b.startDepthCount||0,d=[],e=2;d.push({item_id:"root",parent_id:"none",depth:c,left:"1",right:(a("li",this.element).length+1)*2});a(this.element).children("li").each(function(){e=f(this,c+1,e)});d=d.sort(function(a,b){return a.left-b.left});return d},_clearEmpty:function(b){var c=a(b).children(this.options.listType);if(c.length&&!c.children().length){c.remove()}},_getLevel:function(a){var b=1;if(this.options.listType){var c=a.closest(this.options.listType);while(!c.is(".ui-sortable")){b++;c=c.parent().closest(this.options.listType)}}return b},_getChildLevels:function(b,c){var d=this,e=this.options,f=0;c=c||0;a(b).children(e.listType).children(e.items).each(function(a,b){f=Math.max(d._getChildLevels(b,c+1),f)});return c?f+1:f},_isAllowed:function(a,b){var c=this.options;if(a==null||!a.hasClass(c.disableNesting)){if(c.maxLevels<b&&c.maxLevels!=0){this.placeholder.addClass(c.errorClass);this.beyondMaxLevels=b-c.maxLevels}else{this.placeholder.removeClass(c.errorClass);this.beyondMaxLevels=0}}else{this.placeholder.addClass(c.errorClass);if(c.maxLevels<b&&c.maxLevels!=0){this.beyondMaxLevels=b-c.maxLevels}else{this.beyondMaxLevels=1}}}}));a.ui.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.ui.nestedSortable.prototype.options)})(jQuery)